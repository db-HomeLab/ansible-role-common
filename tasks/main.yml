---
# - name: Import distribution vars
#   ansible.builtin.include_vars: "{{lookup('ansible.builtin.first_found', params)}}"
#   vars:
#     params:
#       files:
#         - '{{ ansible_distribution }}.yml'
#         - '{{ ansible_os_family }}.yml'
#         - default.yml
#       paths:
#         - 'vars'

- name: Install common packages
  ansible.builtin.apt:
    name: "{{ packages }}"
    state: latest
    update_cache: true
  #with_items: "{{ packages }}"
  when: "ansible_os_family == 'Debian'"

- name: Add public keys to hosts
  ansible.posix.authorized_key:
    user: root
    state: present
    key: "{{ item }}"
  loop: "{{ public_keys }}"

- name: Edit sshd_config
  lineinfile:
    path: /etc/ssh/sshd_config
    regex: "{{ item.regex }}"
    line: "{{ item.line }}"
  loop:
    - {'regex': '^(# *)?PermitRootLogin', 'line': 'PermitRootLogin prohibit-password'}
    - {'regex': '^(# *)?PubkeyAuthentication', 'line': 'PubkeyAuthentication yes'}
    - {'regex': '^(# *)?ChallengeResponseAuthentication', 'line': 'ChallengeResponseAuthentication no'}
    - {'regex': '^(# *)?UsePAM', 'line': 'UsePAM yes'}
  notify:
    - "Restart sshd"

